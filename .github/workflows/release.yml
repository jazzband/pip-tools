---
name: ðŸ“¦ Packaging

on:
  release:
    types:
      - published

env:
  FORCE_COLOR: 1 # Request colored output from CLI tools supporting it
  MYPY_FORCE_COLOR: 1 # MyPy's color enforcement
  PIP_DISABLE_PIP_VERSION_CHECK: 1 # Hide "there's a newer pip" message
  PIP_NO_PYTHON_VERSION_WARNING: 1 # Hide "this Python is deprecated" message
  PIP_NO_WARN_SCRIPT_LOCATION: 1 # Hide "script dir is not in $PATH" message
  PRE_COMMIT_COLOR: always
  PY_COLORS: 1 # Recognized by the `py` package, dependency of `pytest`
  PYTHONIOENCODING: utf-8
  PYTHONUTF8: 1
  TOX_PARALLEL_NO_SPINNER: 1 # Disable tox's parallel run spinner animation
  TOX_TESTENV_PASSENV: >- # Make tox-wrapped tools see color requests
    FORCE_COLOR
    MYPY_FORCE_COLOR
    NO_COLOR
    PIP_DISABLE_PIP_VERSION_CHECK
    PIP_NO_PYTHON_VERSION_WARNING
    PIP_NO_WARN_SCRIPT_LOCATION
    PRE_COMMIT_COLOR
    PY_COLORS
    PYTEST_THEME
    PYTEST_THEME_MODE
    PYTHONIOENCODING
    PYTHONLEGACYWINDOWSSTDIO
    PYTHONUTF8

run-name: >-
  ${{
    github.event.action == 'published'
    && format('ðŸ“¦ Releasing {0}...', github.ref_name)
    || format('ðŸŒ± Smoke-testing packaging for commit {0}', github.sha)
  }}
  triggered by: ${{ github.event_name }} of ${{
    github.ref
  }} ${{
    github.ref_type
  }}
  (workflow run ID: ${{
    github.run_id
  }}; number: ${{
    github.run_number
  }}; attempt: ${{
    github.run_attempt
  }})

jobs:
  build-and-test:
    name: >-
      ðŸ“¦ ${{ github.ref_name }}
      [mode: ${{
        github.event.action == 'published'
        && 'release' || 'nightly'
      }}]
    uses: ./.github/workflows/ci.yml
    with:
      release-version: ${{ github.ref_name }}
      release-committish: ''

  publish-pypi:
    name: >-
      ðŸ“¦
      Publish v${{
        needs.build-and-test.outputs.project-version
      }} to PyPI
    needs:
      - build-and-test
    if: >-
      github.event.action == 'published'
      && fromJSON(needs.build-and-test.outputs.is-upstream-repository)

    runs-on: ubuntu-latest

    timeout-minutes: 2 # docker+network are slow sometimes

    environment:
      name: pypi
      url: >-
        https://pypi.org/project/${{
          needs.build-and-test.outputs.project-name
        }}/${{
          needs.build-and-test.outputs.project-version
        }}

    permissions:
      id-token: write # PyPI Trusted Publishing (OIDC)

    steps:
      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: >-
            ${{ needs.build-and-test.outputs.dists-artifact-name }}
          path: dist/
      - name: >-
          ðŸ“¦
          Publish v${{
            needs.build-and-test.outputs.project-version
          }} to PyPI
          ðŸ”
        uses: pypa/gh-action-pypi-publish@release/v1
      - name: Clean up the publish attestation leftovers
        run: rm -fv dist/*.publish.attestation
      - name: Upload packages to Jazzband
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: jazzband
          password: ${{ secrets.JAZZBAND_RELEASE_KEY }}
          repository-url: >-
            https://jazzband.co/projects/${{
              needs.build-and-test.outputs.project-name
            }}/upload
